generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

enum UserRole {
  admin
  operator
  client
  field_officer
}

enum JobStatus {
  scheduled
  sampling
  analysis
  reporting
  completed
}

enum QuotationStatus {
  draft
  sent
  accepted
  rejected
  paid
}

enum SamplingStatus {
  pending
  in_progress
  completed
  cancelled
}

enum OperationalCategory {
  perdiem
  transport
}

model OperationalCatalog {
  id          String              @id @default(uuid())
  category    OperationalCategory
  perdiem_type String?
  location    String?
  distance_category String?
  name        String
  description String?
  price       Decimal             @db.Decimal
  unit        String              @default("unit")
  created_at  DateTime            @default(now())
  updated_at  DateTime            @updatedAt
  history     OperationalHistory[]

  @@map("operational_catalog")
}

model OperationalHistory {
  id          String   @id @default(uuid())
  catalog_id  String
  catalog     OperationalCatalog @relation(fields: [catalog_id], references: [id], onDelete: Cascade)
  action      String   // create, update, delete
  old_price   Decimal? @db.Decimal
  new_price   Decimal? @db.Decimal
  changed_by  String?
  changed_at  DateTime @default(now())

  @@map("operational_history")
}

model Profile {
  id                   String              @id @default(uuid())
  email                String?             @unique
  full_name            String?
  role                 UserRole            @default(client)
  company_name         String?
  address              String?
  created_at           DateTime            @default(now())
  quotations           Quotation[]
  sampling_assignments SamplingAssignment[]

  @@map("profiles")
}

model ServiceCategory {
  id         String    @id @default(uuid())
  name       String    @unique
  created_at DateTime  @default(now())
  services   Service[]

  @@map("service_categories")
}

model Service {
  id           String           @id @default(uuid())
  category_id  String?
  category_ref ServiceCategory? @relation(fields: [category_id], references: [id])
  category     String?          // Made optional for migration
  name         String
  price       Decimal         @db.Decimal
  parameters  Json?
  regulation  String?
  unit        String?
  created_at  DateTime        @default(now())
  items       QuotationItem[]

  @@map("services")
}

model Quotation {
  id               String          @id @default(uuid())
  quotation_number String          @unique
  user_id          String
  profile          Profile         @relation(fields: [user_id], references: [id])
  date             DateTime        @default(now())
  subtotal         Decimal         @default(0) @db.Decimal
  discount_amount  Decimal         @default(0) @db.Decimal
  use_tax          Boolean         @default(true)
  tax_amount       Decimal         @default(0) @db.Decimal
  
  // Additional Costs
  perdiem_price    Decimal         @default(0) @db.Decimal
  perdiem_qty      Int             @default(0)
  transport_price  Decimal         @default(0) @db.Decimal
  transport_qty    Int             @default(0)
  
  total_amount     Decimal         @default(0) @db.Decimal
  status           QuotationStatus @default(draft)
  created_at       DateTime        @default(now())
  items            QuotationItem[]
  job_orders       JobOrder[]

  @@map("quotations")
}

model QuotationItem {
  id                 String    @id @default(uuid())
  quotation_id       String
  quotation          Quotation @relation(fields: [quotation_id], references: [id], onDelete: Cascade)
  service_id         String
  service            Service   @relation(fields: [service_id], references: [id])
  qty                Int       @default(1)
  price_snapshot     Decimal   @db.Decimal
  parameter_snapshot String?

  @@map("quotation_items")
}

model JobOrder {
  id                  String              @id @default(uuid())
  quotation_id        String
  quotation           Quotation           @relation(fields: [quotation_id], references: [id])
  tracking_code       String              @unique
  status              JobStatus           @default(scheduled)
  notes               String?             // Added for progress remarks
  certificate_url     String?
  created_at          DateTime            @default(now())
  sampling_assignment SamplingAssignment?

  @@map("job_orders")
}

model SamplingAssignment {
  id               String          @id @default(uuid())
  job_order_id     String          @unique
  job_order        JobOrder        @relation(fields: [job_order_id], references: [id], onDelete: Cascade)
  field_officer_id String
  field_officer    Profile         @relation(fields: [field_officer_id], references: [id])
  status           SamplingStatus  @default(pending)
  scheduled_date   DateTime
  actual_date      DateTime?
  location         String
  notes            String?
  photos           Json?           // Array of photo URLs
  created_at       DateTime        @default(now())
  updated_at       DateTime        @default(now())
  travel_order     TravelOrder?

  @@map("sampling_assignments")
}

model TravelOrder {
  id                  String           @id @default(uuid())
  assignment_id       String           @unique
  assignment          SamplingAssignment @relation(fields: [assignment_id], references: [id], onDelete: Cascade)
  document_number     String           @unique
  departure_date      DateTime
  return_date         DateTime
  destination         String
  purpose             String
  transportation_type String?
  accommodation_type  String?
  daily_allowance     Decimal?         @db.Decimal(10, 2)
  total_budget        Decimal?         @db.Decimal(10, 2)
  notes               String?
  pdf_url             String?
  created_at          DateTime         @default(now())
  updated_at          DateTime         @default(now())

  @@map("travel_orders")
}

model CompanyProfile {
  id              String   @id @default(uuid())
  company_name    String   @default("WahfaLab")
  address         String?
  phone           String?
  whatsapp        String?
  email           String?
  website         String?
  logo_url        String?
  tagline         String?
  npwp            String?
  created_at      DateTime @default(now())
  updated_at      DateTime @default(now())

  @@map("company_profiles")
}

model Equipment {
  id                String   @id @default(uuid())
  name              String
  category          String?
  specification     String?
  price             Decimal  @db.Decimal
  unit              String   @default("unit")
  availability_status String @default("available")
  quantity          Int      @default(1)
  description       String?
  image_url         String?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  @@map("equipment")
}
